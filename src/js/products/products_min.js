import API_URL_LINK from"../ulity/congfig.js";(()=>{const e=API_URL_LINK,t=5e3,n=4e3,o=10,r=40,s="products:v1",a={name:"productsDB",store:"productsStore",version:1};const i=(()=>{const e=document.createElement("div");return e.style.position="fixed",e.style.top="40%",e.style.right="20px",e.style.zIndex="1000",document.body.appendChild(e),e})();function c(e,t="error",n=3e3){const o=document.createElement("div");o.style.padding="12px 20px",o.style.marginBottom="40%",o.style.borderRadius="4px",o.style.color="#fff",o.style.backgroundColor="error"===t?"#dc3545":"#28a745",o.style.boxShadow="0 2px 4px rgba(0,0,0,0.2)",o.style.opacity="0",o.style.transition="opacity 0.3s ease-in-out",o.textContent=e,i.appendChild(o),requestAnimationFrame((()=>o.style.opacity="1")),setTimeout((()=>{o.style.opacity="0",setTimeout((()=>o.remove()),300)}),n)}function d(){return!!navigator.onLine||(c("No internet connection"),!1)}async function l(){d()&&await async function(){try{const t=performance.now();return await fetch(e,{mode:"no-cors",cache:"no-store"}),!(performance.now()-t>n)}catch{return c("Network error: Unable to reach server"),!1}}()}window.addEventListener("online",(()=>c("Back online","success"))),window.addEventListener("offline",(()=>c("Lost internet connection"))),l(),setInterval(l,5e4);const u=window.fetch.bind(window);window.fetch=async function(...e){if(!d())return c("No network connection"),Promise.reject(new Error("No network connection"));const t=performance.now();try{const n=await u(...e);return performance.now()-t>9e3&&c("Slow network detected"),n}catch(e){throw c("API call failed"),e}};const g=document.getElementById("productsContainer"),p=document.getElementById("go-to-dashboard"),m=document.getElementById("dashboard-overlay"),f=document.getElementById("dashboard-content"),y=document.getElementById("checkout-final"),h=document.getElementById("modify-cart"),v=document.getElementById("close-overlay");g||console.error("Missing #productsContainer in DOM");let w=JSON.parse(sessionStorage.getItem("cart"))||[],b=[],S=[],L="",E="",I=0;function B(e){return e.map((e=>{const t=String(e.ID||e.id||""),n=String(e.Brand||e.brand||"Unknown"),o=String(e.Name||e.name||"N/A"),r=String(e.Type||e.type||"N/A");return{id:t,brand:n,name:o,type:r,quantities:String(e.Quantity||e.quantities||"").toString().split(",").map((e=>parseInt(String(e).trim()))).filter((e=>!isNaN(e)&&e>0)),pricePerKg:parseFloat(e.PricePerKg??e.pricePerKg)||0,status:String(e.Status||e.status||"Inactive").trim(),_s_brand:n.toLowerCase(),_s_name:o.toLowerCase(),_s_type:r.toLowerCase()}}))}function $(){return new Promise(((e,t)=>{const n=indexedDB.open(a.name,a.version);n.onupgradeneeded=()=>{const e=n.result;e.objectStoreNames.contains(a.store)||e.createObjectStore(a.store)},n.onsuccess=()=>e(n.result),n.onerror=()=>t(n.error)}))}function k(){document.querySelectorAll(".skeleton-card").forEach((e=>e.remove()))}function C(e="Something went wrong. Please try again."){k(),g.innerHTML=`\n      <p class="Error">\n        <i class="fa-regular fa-face-sad-tear"></i> ${e}\n        <button id="retry-btn" class="retry-btn">Retry</button>\n      </p>\n    `,document.getElementById("retry-btn")?.addEventListener("click",T)}function T(){w=[],sessionStorage.removeItem("cart"),window.location.reload()}function N(e,t,n){const o=e.querySelector(".actions"),r=w.find((e=>e.id===t.id&&e.weightPerBag===n));o.innerHTML=r?`\n        <button class="decrease" data-id="${t.id}" data-weight="${n}">-</button>\n        <span class="qty">${r.bags}</span>\n        <button class="increase" data-id="${t.id}" data-weight="${n}">+</button>\n      `:`<button class="add-to-cart" data-id="${t.id}" data-weight="${n}">Add to Cart</button>`}function P(e){const t=document.createElement("div");t.className="product-card fade-in-on-scroll",t.dataset.type=e.type||"N/A",t.dataset.id=e.id;const n="Active"!==e.status;n&&t.classList.add("inactive");const o=e.quantities||[];let r="";if(!n&&o.length>0&&(r=o.map((e=>`<option value="${e}">${e} kg</option>`)).join("")),t.innerHTML=`\n      <div class="product-card-image">\n        <img\n          src="${function(e){return`./src/assets/images/${e.id}.jpg`}(e)}"\n          alt="${e.brand||"Product"}"\n          class="product-img"\n          loading="lazy"\n          onerror="this.src='./src/assets/images/default.jpg';"\n        >\n      </div>\n      <div class="product-info">\n        <h3 class="product-name">${e.brand||"Unknown"}</h3>\n        <p class="product-type">${e.name||"N/A"}</p>\n        <p class="product-bag-price">${n?"Out of Stock":"Check price"}</p>\n        ${!n&&r?`\n              <div class="custom-select-container">\n                <div class="custom">\n                  <select id="quantity-${e.id}" class="quantity-select">\n                    <option value="">Select kgs</option>\n                    ${r}\n                  </select>\n                </div>\n              </div>\n              <p class="error-message" id="error-${e.id}" style="display:none;color:red;"></p>\n            `:""}\n        <div class="actions">\n          ${!n&&r?`<button class="add-to-cart" data-id="${e.id}">Add to Cart</button>`:""}\n        </div>\n      </div>\n    `,!n&&r){const n=t.querySelector(".quantity-select"),o=t.querySelector(".product-bag-price"),r=t.querySelector(".error-message");n?.addEventListener("change",(()=>{const s=parseInt(n.value);if(r.style.display="none",s){const n=s*e.pricePerKg;o.textContent=`₹${n} per bag`,N(t,e,s)}else o.textContent="Check price"}))}return t}function q(){let e=document.getElementById("filtered-count");if(!e){const t=document.createElement("div");t.id="count-container",t.innerHTML='<p id="filtered-count">0 results</p>',g?.parentNode?.insertBefore(t,g),e=document.getElementById("filtered-count")}e.textContent=`${S.length} result${1!==S.length?"s":""}`}function A(){let e=document.getElementById("type-filter");if(!e)return;e.innerHTML='\n      <option value="">Select Type</option>\n      <option value="">All</option>\n    ';const t=[...new Set(b.map((e=>e.type)))].sort(),n=document.createDocumentFragment();t.forEach((e=>{const t=document.createElement("option");t.value=e,t.textContent=e,n.appendChild(t)})),e.appendChild(n)}function x(){I=0,g.innerHTML=""}function M(){if(I>=S.length)return;const e=Math.min(I+r,S.length),t=document.createDocumentFragment();for(let n=I;n<e;n++){const e=P(S[n]);t.appendChild(e)}g.appendChild(t),I=e,F()}function _(){window.innerHeight+window.scrollY>=document.body.offsetHeight-600&&M()}const H=function(e,t=250){let n;return(...o)=>{clearTimeout(n),n=setTimeout((()=>e(...o)),t)}}((()=>{const e=L.trim().toLowerCase();S=b.filter((t=>{const n=!e||t._s_name.includes(e)||t._s_brand.includes(e)||t._s_type.includes(e),o=!E||t.type===E;return n&&o})),q(),x(),0===S.length&&b.length>0?g.innerHTML='<p class="Error"><i class="fa-regular fa-face-sad-tear"></i>No products found.</p>':M()}),250);function O(){if(document.getElementById("search-filter-container"))return;const e=document.createElement("div");e.id="search-filter-container",e.innerHTML='\n      <input id="search-input" type="text" placeholder="Search by brand, product, or type..." />\n      <select id="type-filter">\n        <option value="">Select Type</option>\n        <option value="">All</option>\n      </select>\n    ',g?.parentNode?.insertBefore(e,g);const t=document.createElement("div");t.id="count-container",t.innerHTML='<p id="filtered-count">0 results</p>',g?.parentNode?.insertBefore(t,g);const n=document.getElementById("search-input"),o=document.getElementById("type-filter");n?.addEventListener("input",(()=>{L=n.value,H()})),o?.addEventListener("change",(()=>{E=o.value,H()}))}function j(){if(0===w.length)return void m.classList.add("hidden");m.classList.remove("hidden"),f.innerHTML='\n      <table class="cart-table">\n        <thead>\n          <tr>\n            <th>Brand</th>\n            <th>Weight/Bag</th>\n            <th>Bags</th>\n            <th>₹/kg</th>\n            <th>Subtotal</th>\n          </tr>\n        </thead>\n        <tbody></tbody>\n        <tfoot class="tfoot">\n          <tr>\n            <td colspan="4"><strong>Total</strong></td>\n            <td id="total-price"><strong>₹0</strong></td>\n          </tr>\n        </tfoot>\n      </table>\n    ';const e=f.querySelector("tbody");let t=0;const n=document.createDocumentFragment();w.forEach((e=>{const o=e.basePrice*e.weightPerBag*e.bags;t+=o;const r=document.createElement("tr");r.innerHTML=`\n        <td>${e.brand}</td>\n        <td>${e.weightPerBag} kg</td>\n        <td>${e.bags}</td>\n        <td>₹${e.basePrice}</td>\n        <td>₹${o}</td>\n      `,n.appendChild(r)})),e.appendChild(n),f.querySelector("#total-price").innerHTML=`<strong>₹${t}</strong>`}function D(){p&&(p.style.display=w.length>0?"block":"none",p.textContent=`Checkout (${w.length})`)}function F(){const e=document.querySelectorAll(".fade-in-on-scroll:not(.__observed)"),t=new IntersectionObserver(((e,t)=>{e.forEach((e=>{e.isIntersecting&&(e.target.classList.add("visible"),t.unobserve(e.target))}))}),{threshold:.1,rootMargin:"0px 0px -10% 0px"});e.forEach((e=>{e.classList.add("__observed"),t.observe(e)}))}async function J(){try{const e=sessionStorage.getItem(s);if(e)return JSON.parse(e)}catch{}try{const e=await async function(e){const t=await $();return new Promise(((n,o)=>{const r=t.transaction(a.store,"readonly").objectStore(a.store).get(e);r.onsuccess=()=>n(r.result||null),r.onerror=()=>o(r.error)}))}(s);if(e)return e}catch{}return null}async function K(e){try{const t=JSON.stringify(e);new Blob([t]).size<=5242880?sessionStorage.setItem(s,t):await async function(e,t){const n=await $();return new Promise(((o,r)=>{const s=n.transaction(a.store,"readwrite");s.objectStore(a.store).put(t,e),s.oncomplete=()=>o(),s.onerror=()=>r(s.error)}))}(s,e)}catch(e){console.warn("Cache save failed:",e)}}async function U(){!function(e){g.innerHTML="";const t=document.createDocumentFragment(),n=Math.max(e,o);for(let e=0;e<n;e++){const e=document.createElement("div");e.className="skeleton-card",e.innerHTML='\n        <div class="skeleton-img"></div>\n        <div class="skeleton-info">\n          <div class="skeleton-name"></div>\n          <div class="skeleton-quantity"></div>\n          <div class="skeleton-actions"></div>\n        </div>\n      ',t.appendChild(e)}g.appendChild(t)}(o);const n=await J();n&&Array.isArray(n)&&n.length&&(b=B(n),S=[...b],O(),A(),k(),x(),M(),q(),D());try{const o=await async function(e,n={},o=t){const r=new AbortController,s=setTimeout((()=>r.abort()),o);try{const t=await fetch(e,{...n,signal:r.signal,cache:"no-store"});return clearTimeout(s),t}catch(e){throw clearTimeout(s),e}}(e);if(!o.ok)throw new Error(`HTTP error! Status: ${o.status}`);const r=await o.json();if(!Array.isArray(r)||0===r.length)return void(n||C("No products available at the moment."));const s=B(r);b=s,S=[...b],await K(r),k(),O(),A(),x(),M(),q(),D()}catch(e){n?console.error("Fresh fetch failed, using cache:",e):(k(),c("API response is too slow or failed","error"),C(`Failed to load products: ${e.message}`))}}function R(){function e(){document.querySelectorAll(".actions").forEach((e=>{const t=!!e.querySelector(".decrease"),n=!!e.querySelector(".increase");e.classList.toggle("action-visible",t&&n)}));const e=document.getElementById("dashboard-overlay"),t=document.querySelector(".action-visible");e&&e.classList.toggle("active",!!t)}O(),U(),window.addEventListener("scroll",_,{passive:!0}),e(),F();const t=new MutationObserver((()=>{e(),F()}));t.observe(document.body,{childList:!0,subtree:!0}),window.addEventListener("beforeunload",(()=>t.disconnect()))}g?.addEventListener("click",(e=>{const t=e.target;if(!(t instanceof HTMLElement))return;const n=t.dataset?.id;if(!n)return;const o=b.find((e=>e.id===n));if(!o)return;const r=t.closest(".product-card"),s=r?.querySelector(".quantity-select"),a=r?.querySelector(".error-message"),i=parseInt(s?.value);if(t.classList.contains("add-to-cart")){if(!i)return void(a&&(a.textContent="Select a weight.",a.style.display="block"));a&&(a.style.display="none");const e=w.find((e=>e.id===n&&e.weightPerBag===i));e?e.bags++:w.push({id:n,brand:o.brand,weightPerBag:i,bags:1,basePrice:o.pricePerKg}),N(r,o,i),D(),j(),sessionStorage?.setItem("cart",JSON.stringify(w))}if(t.classList.contains("increase")){const e=parseInt(t.dataset.weight),s=w.find((t=>t.id===n&&t.weightPerBag===e));s&&(s.bags++,N(r,o,e),D(),j(),sessionStorage?.setItem("cart",JSON.stringify(w)))}if(t.classList.contains("decrease")){const e=parseInt(t.dataset.weight),s=w.find((t=>t.id===n&&t.weightPerBag===e));s&&(s.bags--,s.bags<=0&&(w=w.filter((t=>!(t.id===n&&t.weightPerBag===e)))),N(r,o,e),D(),j(),sessionStorage?.setItem("cart",JSON.stringify(w)))}})),p?.addEventListener("click",(()=>{0!==w.length&&(j(),p.style.display="none")})),h?.addEventListener("click",(()=>{w=[],sessionStorage.removeItem("cart"),c("Cart cleared","success"),m?.classList.remove("active"),setTimeout((()=>{m?.classList.add("hidden"),D(),j(),document.querySelectorAll(".product-card").forEach((e=>{const t=e.getAttribute("data-id"),n=b.find((e=>e.id===t));if(n&&"Active"===n.status){const t=e.querySelector(".quantity-select"),o=parseInt(t?.value);o&&N(e,n,o)}}))}),500)})),v?.addEventListener("click",(()=>{m?.classList.remove("active"),setTimeout((()=>{m?.classList.add("hidden"),D()}),500)})),y?.addEventListener("click",(()=>{sessionStorage.setItem("cart",JSON.stringify(w)),window.location.href="orders.html"})),"loading"===document.readyState?document.addEventListener("DOMContentLoaded",R,{once:!0}):R()})();