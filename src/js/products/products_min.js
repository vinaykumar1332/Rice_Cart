const productsContainer=document.getElementById("productsContainer"),checkoutBtn=document.getElementById("go-to-dashboard"),dashboardOverlay=document.getElementById("dashboard-overlay"),dashboardContent=document.getElementById("dashboard-content"),finalCheckoutBtn=document.getElementById("checkout-final"),modifyBtn=document.getElementById("modify-cart"),closeOverlayBtn=document.getElementById("close-overlay");let cart=[],products=[],filteredProducts=[],currentIndex=0;const BATCH_SIZE=20;let searchTerm="",selectedType="";function createSearchFilter(){const t=document.createElement("div");t.id="search-filter-container",t.innerHTML='\n    <input id="search-input" type="text" placeholder="Search by brand name..." />\n    <select id="type-filter">\n      <option value="">All Types</option>\n    </select>\n  ',productsContainer?.parentNode?.insertBefore(t,productsContainer);const e=document.getElementById("search-input"),n=document.getElementById("type-filter");e?.addEventListener("input",(()=>{searchTerm=e.value.trim().toLowerCase(),filterProducts()})),n?.addEventListener("change",(()=>{selectedType=n.value,filterProducts()}))}function populateTypeFilter(){const t=document.getElementById("type-filter");[...new Set(products.map((t=>t.type)))].sort().forEach((e=>{const n=document.createElement("option");n.value=e,n.textContent=e,t?.appendChild(n)}))}function filterProducts(){filteredProducts=products.filter((t=>{const e=!searchTerm||t.brand?.toLowerCase().includes(searchTerm),n=!selectedType||t.type===selectedType;return e&&n})),currentIndex=0,productsContainer.innerHTML="",loadNextBatch()}function showSkeletons(t=BATCH_SIZE){for(let e=0;e<t;e++){const t=document.createElement("div");t.className="skeleton-card",t.innerHTML='\n      <div class="skeleton-img"></div>\n      <div class="skeleton-info">\n        <div class="skeleton-name"></div>\n        <div class="skeleton-quantity"></div>\n        <div class="skeleton-actions"></div>\n      </div>\n    ',productsContainer?.appendChild(t)}}function removeSkeletons(){document.querySelectorAll(".skeleton-card").forEach((t=>t.remove()))}function getLocalImage(t){return`./src/assets/images/${t.id}.jpg`}function updateCartUI(t,e,n){const a=t.querySelector(".actions"),r=cart.find((t=>t.id===e.id&&t.weightPerBag===n));a.innerHTML=r?`\n      <button class="decrease" data-id="${e.id}" data-weight="${n}">-</button>\n      <span class="qty">${r.bags} bag(s)</span>\n      <button class="increase" data-id="${e.id}" data-weight="${n}">+</button>\n    `:`<button class="add-to-cart" data-id="${e.id}" data-weight="${n}">Add to Cart</button>`}function createProductCard(t){const e=document.createElement("div");e.className="product-card",e.setAttribute("data-id",t.id);const n="Active"!==t.status;n&&e.classList.add("inactive");const a=t.quantities||[];let r="";if(!n&&a.length>0&&a.forEach((t=>{r+=`<option value="${t}">${t} kg</option>`})),e.innerHTML=`\n    <div class="product-card-image">\n      <img \n        src="${getLocalImage(t)}" \n        alt="${t.brand||"Product"}" \n        class="product-img" \n        loading="lazy"\n        onerror="this.src='./src/assets/images/default.jpg';"\n      >\n    </div>\n    <div class="product-info">\n      <h3 class="product-name">${t.brand||"Unknown"}</h3>\n      <p class="product-type">${t.type||"N/A"}</p>\n      <p class="product-bag-price">${n?"Out of Stock":"Select weight to see price"}</p>\n      ${!n&&r?`\n            <select id="quantity-${t.id}" class="quantity-select">\n              <option value="">Select kgs</option>\n              ${r}\n            </select>\n            <p class="error-message" id="error-${t.id}" style="display: none; color: red;"></p>\n          `:""}\n      <div class="actions">\n        ${!n&&r?`<button class="add-to-cart" data-id="${t.id}">Add to Cart</button>`:""}\n      </div>\n    </div>\n  `,!n&&r){const n=e.querySelector(".quantity-select"),a=e.querySelector(".product-bag-price"),r=e.querySelector(".error-message");n?.addEventListener("change",(()=>{const e=parseInt(n.value);if(r.style.display="none",e){const n=e*t.pricePerKg;a.textContent=`₹${n} per bag`}else a.textContent="Select weight to see price"}))}productsContainer?.appendChild(e)}function loadNextBatch(){filteredProducts.slice(currentIndex,currentIndex+BATCH_SIZE).forEach(createProductCard),currentIndex+=BATCH_SIZE}function handleScroll(){const{scrollTop:t,scrollHeight:e,clientHeight:n}=document.documentElement;t+n>=e-10&&currentIndex<filteredProducts.length&&(showSkeletons(),setTimeout((()=>{removeSkeletons(),loadNextBatch()}),800))}function updateDashboard(){if(0===cart.length)return void dashboardOverlay.classList.add("hidden");dashboardOverlay.classList.remove("hidden"),dashboardContent.innerHTML='\n    <table class="cart-table">\n      <thead>\n        <tr>\n          <th>Brand</th>\n          <th>Weight/Bag</th>\n          <th>Bags</th>\n          <th>₹/kg</th>\n          <th>Subtotal</th>\n        </tr>\n      </thead>\n      <tbody></tbody>\n      <tfoot>\n        <tr>\n          <td colspan="4"><strong>Total</strong></td>\n          <td id="total-price"><strong>₹0</strong></td>\n        </tr>\n      </tfoot>\n    </table>\n  ';const t=dashboardContent.querySelector("tbody");let e=0;cart.forEach((n=>{const a=n.basePrice*n.weightPerBag*n.bags;e+=a;const r=document.createElement("tr");r.innerHTML=`\n      <td>${n.brand}</td>\n      <td>${n.weightPerBag} kg</td>\n      <td>${n.bags}</td>\n      <td>₹${n.basePrice}</td>\n      <td>₹${a}</td>\n    `,t.appendChild(r)})),dashboardContent.querySelector("#total-price").innerHTML=`<strong>₹${e}</strong>`}function toggleCheckout(){checkoutBtn.style.display=cart.length>0?"block":"none",checkoutBtn.textContent=`Checkout (${cart.length})`}productsContainer?.addEventListener("click",(t=>{const e=t.target,n=e.dataset?.id;if(!n)return;const a=products.find((t=>t.id===n));if(!a)return;const r=e.closest(".product-card"),o=r.querySelector(".quantity-select"),s=r.querySelector(".error-message"),c=parseInt(o?.value);if(e.classList.contains("add-to-cart")){if(!c)return s.textContent="Please select a weight.",void(s.style.display="block");s.style.display="none";const t=cart.find((t=>t.id===n&&t.weightPerBag===c));t?t.bags++:cart.push({id:n,brand:a.brand,weightPerBag:c,bags:1,basePrice:a.pricePerKg}),updateCartUI(r,a,c),toggleCheckout(),updateDashboard(),sessionStorage?.setItem("cart",JSON.stringify(cart))}if(e.classList.contains("increase")){const t=parseInt(e.dataset.weight),o=cart.find((e=>e.id===n&&e.weightPerBag===t));o&&(o.bags++,updateCartUI(r,a,t),toggleCheckout(),updateDashboard(),sessionStorage?.setItem("cart",JSON.stringify(cart)))}if(e.classList.contains("decrease")){const t=parseInt(e.dataset.weight),o=cart.find((e=>e.id===n&&e.weightPerBag===t));o&&(o.bags--,o.bags<=0&&(cart=cart.filter((e=>e.id!==n||e.weightPerBag!==t))),updateCartUI(r,a,t),toggleCheckout(),updateDashboard(),sessionStorage?.setItem("cart",JSON.stringify(cart)))}})),checkoutBtn.addEventListener("click",(()=>{0!==cart.length&&(updateDashboard(),checkoutBtn.style.display="none",dashboardOverlay?.classList.remove("hidden"))})),modifyBtn.addEventListener("click",(()=>{dashboardOverlay.classList.add("hidden"),toggleCheckout()})),closeOverlayBtn.addEventListener("click",(()=>{dashboardOverlay.classList.add("hidden"),toggleCheckout()})),finalCheckoutBtn.addEventListener("click",(()=>{sessionStorage.setItem("cart",JSON.stringify(cart)),window.location.href="orders.html"})),createSearchFilter(),showSkeletons(),fetch("https://script.google.com/macros/s/AKfycbzWIlg4U6L71j2jIOxt0Jh6EKvUSDbvrKf7F4AtsbLzY5_YZXjCj_nJ-0wMOjkpHY-G/exec").then((t=>t.json())).then((t=>{products=t.map((t=>({id:t.ID,brand:t.Brand,type:t.Type,quantities:String(t.Quantity||"").split(",").map((t=>parseInt(t.trim()))).filter((t=>!isNaN(t)&&t>0)),pricePerKg:parseFloat(t.PricePerKg),status:t.Status?.trim?.()||"Inactive"}))),filteredProducts=products,populateTypeFilter(),removeSkeletons(),toggleCheckout(),loadNextBatch(),window.addEventListener("scroll",handleScroll)})).catch((t=>{console.error("Error loading products:",t),removeSkeletons(),productsContainer.innerHTML="<p>Error loading products. Please try again later.</p>"}));