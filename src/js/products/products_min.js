document.addEventListener("DOMContentLoaded",(()=>{const e=document.createElement("div");function t(t,n="error"){const o=document.createElement("div");o.style.padding="12px 20px",o.style.marginBottom="40%",o.style.borderRadius="4px",o.style.color="#fff",o.style.backgroundColor="error"===n?"#dc3545":"#28a745",o.style.boxShadow="0 2px 4px rgba(0,0,0,0.2)",o.style.opacity="0",o.style.transition="opacity 0.3s ease-in-out",o.textContent=t,e.appendChild(o),setTimeout((()=>{o.style.opacity="1"}),100),setTimeout((()=>{o.style.opacity="0",setTimeout((()=>o.remove()),300)}),3e3)}function n(){return!!navigator.onLine||(t("No internet connection"),!1)}async function o(){n()&&await async function(){try{const e=performance.now();await fetch("https://script.google.com/macros/s/AKfycbzWIlg4U6L71j2jIOxt0Jh6EKvUSDbvrKf7F4AtsbLzY5_YZXjCj_nJ-0wMOjkpHY-G/exec",{mode:"no-cors",cache:"no-store"});return!(performance.now()-e>4e3&&(t("Slow network detected"),1))}catch(e){return t("Network error: Unable to reach server"),!1}}()}e.style.position="fixed",e.style.top="40%",e.style.right="20px",e.style.zIndex="1000",document.body.appendChild(e),window.addEventListener("online",(()=>{t("Back online","success")})),window.addEventListener("offline",(()=>{t("Lost internet connection")})),o(),setInterval(o,1e4);const s=window.fetch;window.fetch=async function(...e){if(!n())return t("No network connection"),Promise.reject(new Error("No network connection"));const o=performance.now();try{const n=await s(...e);return performance.now()-o>4e3&&t("Slow API response detected"),n}catch(r){throw t("API call failed"),r}};const r=document.getElementById("productsContainer"),a=document.getElementById("go-to-dashboard"),i=document.getElementById("dashboard-overlay"),c=document.getElementById("dashboard-content"),d=document.getElementById("checkout-final"),l=document.getElementById("modify-cart"),u=document.getElementById("close-overlay");let g=JSON.parse(sessionStorage.getItem("cart"))||[],p=[],m=[],y="",f="";const h=10;function v(){m=p.filter((e=>{const t=!y||(e.name?.toLowerCase().includes(y)||e.brand?.toLowerCase().includes(y)||e.type?.toLowerCase().includes(y)),n=!f||e.type===f;return t&&n})),r.innerHTML="",k(),I()}function b(){document.querySelectorAll(".skeleton-card").forEach((e=>e.remove()))}function w(e="Something went wrong. Please try again."){b(),r.innerHTML=`\n      <p class="Error">\n        <i class="fa-regular fa-face-sad-tear"></i> ${e}\n        <button id="retry-btn" class="retry-btn">Retry</button>\n      </p>\n    `,document.getElementById("retry-btn")?.addEventListener("click",L)}function L(){g=[],sessionStorage.removeItem("cart"),window.location.reload(!0)}function E(e,t,n){const o=e.querySelector(".actions"),s=g.find((e=>e.id===t.id&&e.weightPerBag===n));o.innerHTML=s?`\n        <button class="decrease" data-id="${t.id}" data-weight="${n}">-</button>\n        <span class="qty">${s.bags}</span>\n        <button class="increase" data-id="${t.id}" data-weight="${n}">+</button>\n      `:`<button class="add-to-cart" data-id="${t.id}" data-weight="${n}">Add to Cart</button>`}function S(e){const t=document.createElement("div");t.className="product-card fade-in-on-scroll",t.setAttribute("data-type",e.type||"N/A"),t.setAttribute("data-id",e.id);const n="Active"!==e.status;n&&t.classList.add("inactive");const o=e.quantities||[];let s="";if(!n&&o.length>0&&(s=o.map((e=>`<option value="${e}">${e} kg</option>`)).join("")),t.innerHTML=`\n      <div class="product-card-image">\n        <img \n          src="${function(e){return`./src/assets/images/${e.id}.jpg`}(e)}" \n          alt="${e.brand||"Product"}" \n          class="product-img" \n          loading="lazy"\n          onerror="this.src='./src/assets/images/default.jpg';"\n        >\n      </div>\n      <div class="product-info">\n        <h3 class="product-name">${e.brand||"Unknown"}</h3>\n        <p class="product-type">${e.name||"N/A"}</p>\n        <p class="product-bag-price">${n?"Out of Stock":"Check price"}</p>\n        ${!n&&s?`<div class="custom-select-container">\n               <div class="custom">\n                <select id="quantity-${e.id}" class="quantity-select">\n                  <option value="">Select kgs</option>\n                  ${s}\n                </select>\n               </div>\n             </div>\n             <p class="error-message" id="error-${e.id}" style="display: none; color: red;"></p>`:""}\n        <div class="actions">\n          ${!n&&s?`<button class="add-to-cart" data-id="${e.id}">Add to Cart</button>`:""}\n        </div>\n      </div>\n    `,!n&&s){const n=t.querySelector(".quantity-select"),o=t.querySelector(".product-bag-price"),s=t.querySelector(".error-message");n?.addEventListener("change",(()=>{const r=parseInt(n.value);if(s.style.display="none",r){const n=r*e.pricePerKg;o.textContent=`₹${n} per bag`,E(t,e,r)}else o.textContent="Check price"}))}r?.appendChild(t)}function I(){r.innerHTML="",0===m.length&&p.length>0?r.innerHTML='<p class="Error"><i class="fa-regular fa-face-sad-tear"></i>No products found.</p>':m.forEach(S)}function k(){document.getElementById("filtered-count").textContent=`${m.length} result${1!==m.length?"s":""}`}function $(){if(0===g.length)return void i.classList.add("hidden");i.classList.remove("hidden"),c.innerHTML='\n      <table class="cart-table">\n        <thead>\n          <tr>\n            <th>Brand</th>\n            <th>Weight/Bag</th>\n            <th>Bags</th>\n            <th>₹/kg</th>\n            <th>Subtotal</th>\n          </tr>\n        </thead>\n        <tbody></tbody>\n        <tfoot class="tfoot">\n          <tr>\n            <td colspan="4"><strong>Total</strong></td>\n            <td id="total-price"><strong>₹0</strong></td>\n          </tr>\n        </tfoot>\n      </table>\n    ';const e=c.querySelector("tbody");let t=0;g.forEach((n=>{const o=n.basePrice*n.weightPerBag*n.bags;t+=o;const s=document.createElement("tr");s.innerHTML=`\n        <td>${n.brand}</td>\n        <td>${n.weightPerBag} kg</td>\n        <td>${n.bags}</td>\n        <td>₹${n.basePrice}</td>\n        <td>₹${o}</td>\n      `,e.appendChild(s)})),c.querySelector("#total-price").innerHTML=`<strong>₹${t}</strong>`}function C(){a.style.display=g.length>0?"block":"none",a.textContent=`Checkout (${g.length})`}function B(){document.querySelectorAll(".actions").forEach((e=>{const t=null!==e.querySelector(".decrease"),n=null!==e.querySelector(".increase");e.classList.toggle("action-visible",t&&n)}));const e=document.getElementById("dashboard-overlay"),t=document.querySelector(".action-visible");e&&e.classList.toggle("active",!!t)}function T(){const e=document.querySelectorAll(".fade-in-on-scroll"),t=new IntersectionObserver(((e,t)=>{e.forEach((e=>{e.isIntersecting&&(e.target.classList.add("visible"),t.unobserve(e.target))}))}),{threshold:.1,rootMargin:"0px 0px -10% 0px"});e.forEach((e=>t.observe(e)))}r?.addEventListener("click",(e=>{const t=e.target,n=t.dataset?.id;if(!n)return;const o=p.find((e=>e.id===n));if(!o)return;const s=t.closest(".product-card"),r=s.querySelector(".quantity-select"),a=s.querySelector(".error-message"),i=parseInt(r?.value);if(t.classList.contains("add-to-cart")){if(!i)return a.textContent="Select a weight.",void(a.style.display="block");a.style.display="none";const e=g.find((e=>e.id===n&&e.weightPerBag===i));e?e.bags++:g.push({id:n,brand:o.brand,weightPerBag:i,bags:1,basePrice:o.pricePerKg}),E(s,o,i),C(),$(),sessionStorage?.setItem("cart",JSON.stringify(g))}if(t.classList.contains("increase")){const e=parseInt(t.dataset.weight),r=g.find((t=>t.id===n&&t.weightPerBag===e));r&&(r.bags++,E(s,o,e),C(),$(),sessionStorage?.setItem("cart",JSON.stringify(g)))}if(t.classList.contains("decrease")){const e=parseInt(t.dataset.weight),r=g.find((t=>t.id===n&&t.weightPerBag===e));r&&(r.bags--,r.bags<=0&&(g=g.filter((t=>t.id!==n||t.weightPerBag!==e))),E(s,o,e),C(),$(),sessionStorage?.setItem("cart",JSON.stringify(g)))}})),a.addEventListener("click",(()=>{0!==g.length&&($(),a.style.display="none")})),l.addEventListener("click",(()=>{g=[],sessionStorage.removeItem("cart"),t("Cart cleared","success"),i.classList.remove("active"),setTimeout((()=>{i.classList.add("hidden"),C(),$(),document.querySelectorAll(".product-card").forEach((e=>{const t=e.dataset.id,n=p.find((e=>e.id===t));if(n&&"Active"!==!n.status){const t=e.querySelector(".quantity-select"),o=parseInt(t?.value);o&&E(e,n,o)}}))}),500)})),u.addEventListener("click",(()=>{i.classList.remove("active"),setTimeout((()=>{i.classList.add("hidden"),C()}),500)})),d.addEventListener("click",(()=>{sessionStorage.setItem("cart",JSON.stringify(g)),window.location.href="orders.html"})),function(){const e=document.createElement("div");e.id="search-filter-container",e.innerHTML='\n      <input id="search-input" type="text" placeholder="Search by brand name..." />\n      <select id="type-filter">\n        <option value="">All Types</option>\n      </select>\n    ',r?.parentNode?.insertBefore(e,r);const t=document.createElement("div");t.id="count-container",t.innerHTML='<p id="filtered-count">0 results</p>',r?.parentNode?.insertBefore(t,r);const n=document.getElementById("search-input"),o=document.getElementById("type-filter");let s;n?.addEventListener("input",(()=>{clearTimeout(s),s=setTimeout((()=>{y=n.value.trim().toLowerCase(),v()}),300)})),o?.addEventListener("change",(()=>{f=o.value,v()}))}(),async function(){!function(e){r.innerHTML="";for(let t=0;t<Math.max(e,h);t++){const e=document.createElement("div");e.className="skeleton-card",e.innerHTML='\n        <div class="skeleton-img"></div>\n        <div class="skeleton-info">\n          <div class="skeleton-name"></div>\n          <div class="skeleton-quantity"></div>\n          <div class="skeleton-actions"></div>\n        </div>\n      ',r?.appendChild(e)}}(h);const e=new AbortController,n=setTimeout((()=>{e.abort(),t("API response is too slow"),w("API took too long to respond. Please try again.")}),5e3);try{const t=await fetch("https://script.google.com/macros/s/AKfycbzWIlg4U6L71j2jIOxt0Jh6EKvUSDbvrKf7F4AtsbLzY5_YZXjCj_nJ-0wMOjkpHY-G/exec",{signal:e.signal});clearTimeout(n);const o=await t.json();p=o.map((e=>({id:e.ID,brand:e.Brand,name:e.Name,type:e.Type,quantities:String(e.Quantity||"").split(",").map((e=>parseInt(e.trim()))).filter((e=>!isNaN(e)&&e>0)),pricePerKg:parseFloat(e.PricePerKg),status:e.Status?.trim?.()||"Inactive"}))),m=[...p],function(){const e=document.getElementById("type-filter");[...new Set(p.map((e=>e.type)))].sort().forEach((t=>{const n=document.createElement("option");n.value=t,n.textContent=t,e?.appendChild(n)}))}(),b(),I(),k(),C()}catch(o){clearTimeout(n),console.error("Error loading products:",o),t("Failed to load products"),w()}}(),document.addEventListener("DOMContentLoaded",(()=>{B(),T()}));const q=new MutationObserver((()=>{B(),T()}));q.observe(document.body,{childList:!0,subtree:!0}),window.addEventListener("beforeunload",(()=>q.disconnect()))}));