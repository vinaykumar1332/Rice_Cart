document.addEventListener("DOMContentLoaded",(()=>{const e=document.createElement("div");function t(t,n="error"){const o=document.createElement("div");Object.assign(o.style,{padding:"12px 20px",marginBottom:"40%",borderRadius:"4px",color:"#fff",backgroundColor:"error"===n?"#dc3545":"#28a745",boxShadow:"0 2px 4px rgba(0,0,0,0.2)",opacity:"0",transition:"opacity 0.3s ease-in-out"}),o.textContent=t,e.appendChild(o),requestAnimationFrame((()=>{o.style.opacity="1"})),setTimeout((()=>{o.style.opacity="0",setTimeout((()=>o.remove()),300)}),3e3)}async function n(){return!!navigator.onLine||(t("No internet connection"),!1)}async function o(){await n()&&await async function(e){try{const n=performance.now();return await fetch(e,{mode:"no-cors",cache:"no-store",signal:AbortSignal.timeout(4e3)}),!(performance.now()-n>4e3&&(t("API response too slow"),1))}catch(e){return t("Network error: Unable to reach server"),!1}}("https://script.google.com/macros/s/AKfycbzWIlg4U6L71j2jIOxt0Jh6EKvUSDbvrKf7F4AtsbLzY5_YZXjCj_nJ-0wMOjkpHY-G/exec")}Object.assign(e.style,{position:"fixed",top:"40%",right:"20px",zIndex:"1000"}),document.body.appendChild(e),window.addEventListener("online",(()=>t("Back online","success"))),window.addEventListener("offline",(()=>t("Lost internet connection")));let r=0;setInterval((function(){const e=Date.now();e-r>5e4&&(r=e,o())}),1e4);const a=window.fetch;window.fetch=async function(...e){if(!await n())return t("No network connection"),Promise.reject(new Error("No network connection"));const o=performance.now();try{const n=await a(...e);return performance.now()-o>9e3?(t("API call too slow"),Promise.reject(new Error("API call too slow"))):n}catch(e){throw t("API call failed"),e}};const s=document.getElementById("productsContainer"),i=document.getElementById("go-to-dashboard"),c=document.getElementById("dashboard-overlay"),d=document.getElementById("dashboard-content"),l=document.getElementById("checkout-final"),u=document.getElementById("modify-cart"),g=document.getElementById("close-overlay");let p=JSON.parse(sessionStorage.getItem("cart"))||[],m=[],f=[],h="",y="";const v=10;function b(){const e=document.getElementById("type-filter");[...new Set(m.map((e=>e.type)))].sort().forEach((t=>{const n=document.createElement("option");n.value=t,n.textContent=t,e?.appendChild(n)}))}function w(){f=m.filter((e=>{const t=!h||(e.name?.toLowerCase().includes(h)||e.brand?.toLowerCase().includes(h)||e.type?.toLowerCase().includes(h)),n=!y||e.type===y;return t&&n})),k(),$()}function L(){s.innerHTML=""}function E(e="Something went wrong. Please try again."){L(),s.innerHTML=`\n      <p class="Error">\n        <i class="fa-regular fa-face-sad-tear"></i> ${e}\n        <button id="retry-btn" class="retry-btn">Retry</button>\n      </p>\n    `,document.getElementById("retry-btn")?.addEventListener("click",S)}function S(){p=[],sessionStorage.removeItem("cart"),window.location.reload(!0)}function I(e,t,n){const o=e.querySelector(".actions"),r=p.find((e=>e.id===t.id&&e.weightPerBag===n));o.innerHTML=r?`\n        <button class="decrease" data-id="${t.id}" data-weight="${n}">-</button>\n        <span class="qty">${r.bags}</span>\n        <button class="increase" data-id="${t.id}" data-weight="${n}">+</button>\n      `:`<button class="add-to-cart" data-id="${t.id}" data-weight="${n}">Add to Cart</button>`}function $(){const e=document.createDocumentFragment();0===f.length&&m.length>0?s.innerHTML='<p class="Error"><i class="fa-regular fa-face-sad-tear"></i>No products found.</p>':(f.forEach((t=>e.appendChild(function(e){const t=document.createElement("div");t.className="product-card fade-in-on-scroll",t.setAttribute("data-type",e.type||"N/A"),t.setAttribute("data-id",e.id);const n="Active"!==e.status;n&&t.classList.add("inactive");const o=e.quantities||[],r=!n&&o.length>0?o.map((e=>`<option value="${e}">${e} kg</option>`)).join(""):"";if(t.innerHTML=`\n      <div class="product-card-image">\n        <img \n          src="${function(e){return`./src/assets/images/${e.id}.jpg`}(e)}" \n          alt="${e.brand||"Product"}" \n          class="product-img" \n          loading="lazy"\n          onerror="this.src='./src/assets/images/default.jpg';"\n        >\n      </div>\n      <div class="product-info">\n        <h3 class="product-name">${e.brand||"Unknown"}</h3>\n        <p class="product-type">${e.name||"N/A"}</p>\n        <p class="product-bag-price">${n?"Out of Stock":"Check price"}</p>\n        ${!n&&r?`<div class="custom-select-container">\n               <div class="custom">\n                <select id="quantity-${e.id}" class="quantity-select">\n                  <option value="">Select kgs</option>\n                  ${r}\n                </select>\n               </div>\n             </div>\n             <p class="error-message" id="error-${e.id}" style="display: none; color: red;"></p>`:""}\n        <div class="actions">\n          ${!n&&r?`<button class="add-to-cart" data-id="${e.id}">Add to Cart</button>`:""}\n        </div>\n      </div>\n    `,!n&&r){const n=t.querySelector(".quantity-select"),o=t.querySelector(".product-bag-price"),r=t.querySelector(".error-message");n?.addEventListener("change",(()=>{const a=parseInt(n.value);if(r.style.display="none",a){const n=a*e.pricePerKg;o.textContent=`₹${n} per bag`,I(t,e,a)}else o.textContent="Check price"}))}return t}(t)))),s.innerHTML="",s.appendChild(e))}function k(){document.getElementById("filtered-count").textContent=`${f.length} result${1!==f.length?"s":""}`}function C(){if(0===p.length)return void c.classList.add("hidden");c.classList.remove("hidden");const e=document.createDocumentFragment(),t=document.createElement("table");t.className="cart-table",t.innerHTML='\n      <thead>\n        <tr>\n          <th>Brand</th>\n          <th>Weight/Bag</th>\n          <th>Bags</th>\n          <th>₹/kg</th>\n          <th>Subtotal</th>\n        </tr>\n      </thead>\n      <tbody></tbody>\n      <tfoot class="tfoot">\n        <tr>\n          <td colspan="4"><strong>Total</strong></td>\n          <td id="total-price"><strong>₹0</strong></td>\n        </tr>\n      </tfoot>\n    ';const n=t.querySelector("tbody");let o=0;p.forEach((e=>{const t=e.basePrice*e.weightPerBag*e.bags;o+=t;const r=document.createElement("tr");r.innerHTML=`\n        <td>${e.brand}</td>\n        <td>${e.weightPerBag} kg</td>\n        <td>${e.bags}</td>\n        <td>₹${e.basePrice}</td>\n        <td>₹${t}</td>\n      `,n.appendChild(r)})),t.querySelector("#total-price").innerHTML=`<strong>₹${o}</strong>`,e.appendChild(t),d.innerHTML="",d.appendChild(e)}function B(){i.style.display=p.length>0?"block":"none",i.textContent=`Checkout (${p.length})`}s?.addEventListener("click",(e=>{const t=e.target,n=t.dataset?.id;if(!n)return;const o=m.find((e=>e.id===n));if(!o)return;const r=t.closest(".product-card"),a=r.querySelector(".quantity-select"),s=r.querySelector(".error-message"),i=parseInt(a?.value);if(t.classList.contains("add-to-cart")){if(!i)return s.textContent="Select a weight.",void(s.style.display="block");s.style.display="none";const e=p.find((e=>e.id===n&&e.weightPerBag===i));e?e.bags++:p.push({id:n,brand:o.brand,weightPerBag:i,bags:1,basePrice:o.pricePerKg}),I(r,o,i),B(),C(),sessionStorage?.setItem("cart",JSON.stringify(p))}if(t.classList.contains("increase")||t.classList.contains("decrease")){const e=parseInt(t.dataset.weight),a=p.find((t=>t.id===n&&t.weightPerBag===e));a&&(a.bags+=t.classList.contains("increase")?1:-1,a.bags<=0&&(p=p.filter((t=>t.id!==n||t.weightPerBag!==e))),I(r,o,e),B(),C(),sessionStorage?.setItem("cart",JSON.stringify(p)))}})),i.addEventListener("click",(()=>{0!==p.length&&(C(),i.style.display="none")})),u.addEventListener("click",(()=>{p=[],sessionStorage.removeItem("cart"),t("Cart cleared","success"),c.classList.remove("active"),setTimeout((()=>{c.classList.add("hidden"),B(),C(),document.querySelectorAll(".product-card").forEach((e=>{const t=e.dataset.id,n=m.find((e=>e.id===t));if(n&&"Active"===n.status){const t=e.querySelector(".quantity-select"),o=parseInt(t?.value);o&&I(e,n,o)}}))}),500)})),g.addEventListener("click",(()=>{c.classList.remove("active"),setTimeout((()=>{c.classList.add("hidden"),B()}),500)})),l.addEventListener("click",(()=>{sessionStorage.setItem("cart",JSON.stringify(p)),window.location.href="orders.html"})),function(){const e=document.createElement("div");e.id="search-filter-container",e.innerHTML='\n      <input id="search-input" type="text" placeholder="Search by brand name..." />\n      <select id="type-filter">\n        <option value="">All Types</option>\n      </select>\n    ',s?.parentNode?.insertBefore(e,s);const t=document.createElement("div");t.id="count-container",t.innerHTML='<p id="filtered-count">0 results</p>',s?.parentNode?.insertBefore(t,s);const n=document.getElementById("search-input"),o=document.getElementById("type-filter");let r;n?.addEventListener("input",(()=>{clearTimeout(r),r=setTimeout((()=>{h=n.value.trim().toLowerCase(),w()}),300)})),o?.addEventListener("change",(()=>{y=o.value,w()}))}(),async function(e=3,n=1e3){!function(e){const t=document.createDocumentFragment();for(let n=0;n<Math.max(e,v);n++){const e=document.createElement("div");e.className="skeleton-card",e.innerHTML='\n        <div class="skeleton-img"></div>\n        <div class="skeleton-info">\n          <div class="skeleton-name"></div>\n          <div class="skeleton-quantity"></div>\n          <div class="skeleton-actions"></div>\n        </div>\n      ',t.appendChild(e)}s.innerHTML="",s.appendChild(t)}(v);for(let o=1;o<=e;o++)try{const e=new AbortController,t=setTimeout((()=>e.abort()),5e3),n=await fetch("https://script.google.com/macros/s/AKfycbzWIlg4U6L71j2jIOxt0Jh6EKvUSDbvrKf7F4AtsbLzY5_YZXjCj_nJ-0wMOjkpHY-G/exec",{signal:e.signal});if(clearTimeout(t),!n.ok)throw new Error(`HTTP error! Status: ${n.status}`);const o=await n.json();if(!Array.isArray(o)||0===o.length)throw new Error("No valid product data received");m=o.map((e=>({id:String(e.ID||""),brand:String(e.Brand||"Unknown"),name:String(e.Name||"N/A"),type:String(e.Type||"N/A"),quantities:String(e.Quantity||"").split(",").map((e=>parseInt(e.trim()))).filter((e=>!isNaN(e)&&e>0)),pricePerKg:parseFloat(e.PricePerKg)||0,status:String(e.Status||"Inactive").trim()})));try{const e=JSON.stringify(m);if(new Blob([e]).size>5242880)throw new Error("Data too large for sessionStorage")}catch(e){console.error("Error saving to sessionStorage:",e)}return f=[...m],b(),L(),$(),k(),void B()}catch(r){console.error(`Attempt ${o} failed:`,r),o===e?(t(`Failed to load products: ${r.message}`,"error"),E(`Failed to load products: ${r.message}`)):await new Promise((e=>setTimeout(e,n)))}}();const A=new MutationObserver((()=>{!function(){document.querySelectorAll(".actions").forEach((e=>{const t=e.querySelector(".decrease")&&e.querySelector(".increase");e.classList.toggle("action-visible",t)}));const e=document.getElementById("dashboard-overlay"),t=document.querySelector(".action-visible");e&&e.classList.toggle("active",!!t)}(),function(){const e=new IntersectionObserver(((e,t)=>{e.forEach((e=>{e.isIntersecting&&(e.target.classList.add("visible"),t.unobserve(e.target))}))}),{threshold:.1,rootMargin:"0px 0px -10% 0px"});document.querySelectorAll(".fade-in-on-scroll").forEach((t=>e.observe(t)))}()}));A.observe(document.body,{childList:!0,subtree:!0}),window.addEventListener("beforeunload",(()=>A.disconnect()))}));