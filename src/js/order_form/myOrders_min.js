const mobileInput=document.getElementById("mobile"),clearIcon=document.querySelector(".clear-icon");function formatDate(e){return e&&"N/A"!==e?new Date(e).toLocaleString("en-IN",{timeZone:"Asia/Kolkata"}):"N/A"}async function searchOrder(){const e=mobileInput.value.trim(),t=document.getElementById("result"),n=document.getElementById("loader"),r=document.getElementById("filterTags");if(t.innerHTML="",r.innerHTML="",n.style.display="block",mobileInput.classList.remove("invalid"),!/^\d{10}$/.test(e))return n.style.display="none",t.innerHTML='<p class="error"><i class="fa-solid fa-heart-crack"></i> Please enter a valid 10-digit mobile number.</p>',void mobileInput.classList.add("invalid");localStorage.setItem("savedMobile",e);try{const o=await fetch(`https://script.google.com/macros/s/AKfycbx3duJLyCpMpvdOrEk4_ixxb4ooXM9rB8rPmP-Uk8hqvx00XAfjL135J8mZZWIy2jz5/exec?mobile=${e}`),s=await o.json();if(console.log("Response data:",JSON.stringify(s,null,2)),n.style.display="none",s.success&&Array.isArray(s.orders)&&s.orders.length>0){const e={};s.orders.forEach((t=>{const n=t.Orders?t.Orders.toLowerCase().replace(/\s+/g,"-"):"opened";e[n]=(e[n]||0)+1}));let n='<span class="tag" data-status="all">All ('+s.orders.length+")</span>";for(const t in e){const r="opened"===t?"Opened":t.replace(/-/g," ").replace(/\b\w/g,(e=>e.toUpperCase()));n+=`<span class="tag" data-status="${t}">${r} (${e[t]})</span>`}r.innerHTML=n;const o=r.getElementsByClassName("tag");let a="all";for(const e of o)e.addEventListener("click",(function(){for(const e of o)e.classList.remove("active");this.classList.add("active"),a=this.getAttribute("data-status");let e="";s.orders.forEach(((t,n)=>{if("all"!==a&&(t.Orders?t.Orders.toLowerCase().replace(/\s+/g,"-"):"opened")!==a)return;const r=t.Brand||"N/A",o=t["Weight per Bag"]||"N/A",s=t.Bags||"N/A",i=t["Total Price"]||"N/A",l=t.Orders||"Opened",d=t.Orders?"status-"+t.Orders.toLowerCase().replace(/\s+/g,"-"):"status-opened",c=formatDate(t.timestamp)||"N/A",p=t.Name||"N/A",g=t.Address||"N/A",m=t["GPS Location"]||"N/A";let u="";[r,o,s,i,l,c,p,g,m].every((e=>"N/A"===e))&&(u=`\n                <p><strong>Raw Order Data (for debugging):</strong></p>\n                <pre class="raw-data">${JSON.stringify(t,null,2)}</pre>\n              `),e+=`\n              <div class="order" id="downloadDiv-${n}">\n                <button class="download-btn" data-index="${n}" title="Download Order Details">\n                  <i class="fa-solid fa-file-pdf"></i>\n                </button>\n                <h3>Order ${n+1}</h3>\n                <p><strong>Ordered On:</strong> <span>${c}</span></p>\n                <p><strong>Name:</strong> ${p}</p>\n                <p><strong>Rice Brand:</strong> ${r}</p>\n                <p><strong>Weight Per Bag:</strong> ${o}</p>\n                <p><strong>Total Bags:</strong> ${s}</p>\n                <p><strong>Total Price:</strong> ${i}</p>\n                <p class="address-none"><strong>Address:</strong> ${g}</p>\n                <p class="gps-location"><strong>GPS Location:</strong> <a href="${m}" target="_blank" rel="noopener noreferrer">View Location</a></p>\n                <p class="${d}"><strong>Status:</strong> ${l}</p>\n                ${u}\n              </div>\n            `})),t.innerHTML=e||'<p class="error"><i class="fa-solid fa-face-frown"></i> No orders found for this status.</p>'}));o[0].classList.add("active"),o[0].click()}else t.innerHTML='<p class="error"><i class="fa-solid fa-face-frown"></i> '+(s.message||"No orders found.")+"</p>"}catch(e){console.error("Error fetching order details:",e),n.style.display="none",t.innerHTML='<p class="error"><i class="fa-solid fa-face-frown"></i> Error fetching order details. Please try again later.</p>'}}mobileInput.addEventListener("input",(function(e){this.value=this.value.replace(/[^0-9]/g,""),clearIcon.style.display=this.value.length>0?"block":"none"})),clearIcon.addEventListener("click",(function(){mobileInput.value="",localStorage.removeItem("savedMobile"),clearIcon.style.display="none",document.getElementById("result").innerHTML="",document.getElementById("filterTags").innerHTML=""})),window.addEventListener("load",(function(){const e=localStorage.getItem("savedMobile");e&&(mobileInput.value=e,clearIcon.style.display=e.length>0?"block":"none",searchOrder())})),document.addEventListener("DOMContentLoaded",(()=>{document.addEventListener("click",(async e=>{if(e.target.closest(".download-btn")){const t=e.target.closest(".download-btn").getAttribute("data-index"),n=document.querySelector(`#downloadDiv-${t}`);if(!n)return void alert("Order content not found.");const r=n.cloneNode(!0),o=r.querySelector(".download-btn");o&&o.remove();const s=r.querySelector(".gps-location a");if(s){const e=s.textContent;s.replaceWith(e)}const a=document.createElement("div");a.style.background="#fff",a.style.color="#000",a.style.fontFamily="Arial, sans-serif",a.style.fontSize="14px",a.style.padding="30px",a.style.width="100%",a.style.boxSizing="border-box";const i=document.createElement("div");i.innerHTML='\n        <div style="text-align:center; margin-bottom:20px;">\n          <img src="https://www.google.com/url?sa=i&url=https%3A%2F%2Fin.pinterest.com%2Fpin%2Frice-png-and-clipart-images-with-transparent-background--740631101235829758%2F&psig=AOvVaw1AStE1nAQjl6ieyBPfuiOb&ust=1750668149610000&source=images&cd=vfe&opi=89978449&ved=0CBEQjRxqFwoTCPDg-prRhI4DFQAAAAAdAAAAABAE" alt="Logo" style="height:60px; margin-bottom:10px;" />\n          <h2 style="margin:0; font-size:20px;">Sri Lakshmi Rice Distributors</h2>\n          <p style="margin:0;">Hyderabad, Telangana - 500081</p>\n          <p style="margin:0;">Phone: +91-9876543210 | Email: support@slricedistributors.com</p>\n          <hr style="margin:20px 0;" />\n        </div>\n      ';const l=document.createElement("div");l.innerHTML='\n        <hr style="margin:20px 0;" />\n        <p style="text-align:center; font-size:13px;">Thank you for your order! Visit us at <strong>srilakshmirice.com</strong></p>\n      ',a.appendChild(i),a.appendChild(r),a.appendChild(l);const d=document.createElement("div");d.style.position="absolute",d.style.left="-9999px",d.appendChild(a),document.body.appendChild(d);try{await html2pdf().set({margin:.5,filename:`order-${parseInt(t)+1}-details.pdf`,image:{type:"jpeg",quality:.98},html2canvas:{scale:2,useCORS:!0},jsPDF:{unit:"in",format:"letter",orientation:"portrait"}}).from(a).save()}catch(e){console.error("PDF generation failed:",e),alert("Failed to generate PDF. Try again.")}finally{document.body.removeChild(d)}}}))}));