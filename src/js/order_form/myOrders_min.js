const mobileInput=document.getElementById("mobile"),clearIcon=document.querySelector(".clear-icon");function formatDate(e){return e&&"N/A"!==e?new Date(e).toLocaleString("en-IN",{timeZone:"Asia/Kolkata"}):"N/A"}async function searchOrder(){const e=mobileInput.value.trim(),t=document.getElementById("result"),n=document.getElementById("loader"),o=document.getElementById("filterTags");if(t.innerHTML="",o.innerHTML="",n.style.display="block",mobileInput.classList.remove("invalid"),!/^\d{10}$/.test(e))return n.style.display="none",t.innerHTML='<p class="error"><i class="fa-solid fa-heart-crack"></i> Please enter a valid 10-digit mobile number.</p>',void mobileInput.classList.add("invalid");localStorage.setItem("savedMobile",e);try{const r=await fetch(`https://script.google.com/macros/s/AKfycbx3duJLyCpMpvdOrEk4_ixxb4ooXM9rB8rPmP-Uk8hqvx00XAfjL135J8mZZWIy2jz5/exec?mobile=${e}`),s=await r.json();if(console.log("Response data:",JSON.stringify(s,null,2)),n.style.display="none",s.success&&Array.isArray(s.orders)&&s.orders.length>0){const e={};s.orders.forEach((t=>{const n=t.Orders?t.Orders.toLowerCase().replace(/\s+/g,"-"):"opened";e[n]=(e[n]||0)+1}));let n='<span class="tag" data-status="all">All ('+s.orders.length+")</span>";for(const t in e){const o="opened"===t?"Opened":t.replace(/-/g," ").replace(/\b\w/g,(e=>e.toUpperCase()));n+=`<span class="tag" data-status="${t}">${o} (${e[t]})</span>`}o.innerHTML=n;const r=o.getElementsByClassName("tag");let a="all";for(const e of r)e.addEventListener("click",(function(){for(const e of r)e.classList.remove("active");this.classList.add("active"),a=this.getAttribute("data-status");let e="";s.orders.forEach(((t,n)=>{if("all"!==a&&(t.Orders?t.Orders.toLowerCase().replace(/\s+/g,"-"):"opened")!==a)return;const o=t.Brand||"N/A",r=t["Weight per Bag"]||"N/A",s=t.Bags||"N/A",l=t["Total Price"]||"N/A",i=t.Orders||"Opened",d=t.Orders?"status-"+t.Orders.toLowerCase().replace(/\s+/g,"-"):"status-opened",c=formatDate(t.timestamp)||"N/A",p=t.Name||"N/A",g=t.Address||"N/A",f=t["GPS Location"]||"N/A";let u="";[o,r,s,l,i,c,p,g,f].every((e=>"N/A"===e))&&(u=`\n                                <p><strong>Raw Order Data (for debugging):</strong></p>\n                                <pre class="raw-data">${JSON.stringify(t,null,2)}</pre>\n                            `),e+=`\n                            <div class="order" id="downloadDiv-${n}>\n                            <button class="download-btn" data-index="${n}" title="Download Order Details">\n                                <i class="fa-solid fa-file-pdf"></i>\n                            </button>\n                                <h3>Order ${n+1}</h3>\n                                <p><strong>Ordered On:</strong> ${c}</p>\n                                <p><strong>Name:</strong> ${p}</p>\n                                <p><strong>Rice Brand:</strong> ${o}</p>\n                                <p><strong>Weight Per Bag:</strong> ${r}</p>\n                                <p><strong>Total Bags:</strong> ${s}</p>\n                                <p><strong>Total Price:</strong> ${l}</p>\n                                <p class="address-none"><strong>Address:</strong> ${g}</p>\n                                <p class="gps-location"><strong>GPS Location:</strong> <a href="${f}" target="_blank" rel="noopener noreferrer">View Location</a></p>\n                                <p class="${d}"><strong>Status:</strong> ${i}</p>\n                                ${u}\n                            </div>\n                        `})),t.innerHTML=e||'<p class="error"><i class="fa-solid fa-face-frown"></i> No orders found for this status.</p>'}));r[0].classList.add("active"),r[0].click()}else t.innerHTML='<p class="error"><i class="fa-solid fa-face-frown"></i> '+(s.message||"No orders found.")+"</p>"}catch(e){console.error("Error fetching order details:",e),n.style.display="none",t.innerHTML='<p class="error"><i class="fa-solid fa-face-frown"></i> Error fetching order details. Please try again later.</p>'}}mobileInput.addEventListener("input",(function(e){this.value=this.value.replace(/[^0-9]/g,""),clearIcon.style.display=this.value.length>0?"block":"none"})),clearIcon.addEventListener("click",(function(){mobileInput.value="",localStorage.removeItem("savedMobile"),clearIcon.style.display="none",document.getElementById("result").innerHTML="",document.getElementById("filterTags").innerHTML=""})),window.addEventListener("load",(function(){const e=localStorage.getItem("savedMobile");e&&(mobileInput.value=e,clearIcon.style.display=e.length>0?"block":"none",searchOrder())})),document.addEventListener("DOMContentLoaded",(()=>{document.addEventListener("click",(e=>{if(e.target.closest(".download-btn")){const t=e.target.closest(".download-btn"),n=t.getAttribute("data-index"),o=document.querySelector(`#downloadDiv-${n}`);if(!o)return void console.error(`Order div with ID downloadDiv-${n} not found.`);const r=document.createElement("div");r.className="pdf-loader",r.innerHTML="<span>Generating PDF...</span>",o.appendChild(r),t.style.pointerEvents="none";const s=o.cloneNode(!0),a=s.querySelector(".download-btn");a&&a.remove();const l=s.querySelector(".pdf-loader");l&&l.remove();s.querySelectorAll("i.fa-solid").forEach((e=>e.remove()));const i=s.querySelector(".gps-location");i&&(i.innerHTML="<strong>GPS Location:</strong> [Link Removed for PDF]"),s.style.position="static",s.style.display="block",s.style.width="100%",s.style.background="#fff",s.style.padding="20px",s.style.boxSizing="border-box",s.style.fontFamily="Arial, sans-serif",s.style.color="#000",s.style.overflow="visible";s.querySelectorAll("p, h3").forEach((e=>{e.style.color="#000",e.style.margin="5px 0",e.style.fontFamily="Arial, sans-serif"})),s.style.position="absolute",s.style.left="-9999px",document.body.appendChild(s);const d={margin:.5,filename:`order-${parseInt(n)+1}-details.pdf`,image:{type:"jpeg",quality:.98},html2canvas:{scale:2,useCORS:!0,logging:!0},jsPDF:{unit:"in",format:"letter",orientation:"portrait"}};setTimeout((()=>{console.log("Cloned content for PDF:",s.innerHTML),html2pdf().from(s).set(d).save().then((()=>{r.remove(),t.style.pointerEvents="auto",s.remove()})).catch((e=>{console.error("Error generating PDF:",e),r.remove(),t.style.pointerEvents="auto",s.remove(),alert("Error generating PDF. Please try again.")}))}),200)}}))}));