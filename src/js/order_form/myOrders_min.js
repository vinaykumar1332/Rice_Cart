const mobileInput=document.getElementById("mobile"),clearIcon=document.querySelector(".clear-icon");function formatDate(e){return e&&"N/A"!==e?new Date(e).toLocaleString("en-IN",{timeZone:"Asia/Kolkata"}):"N/A"}async function searchOrder(){const e=mobileInput.value.trim(),t=document.getElementById("result"),r=document.getElementById("loader"),s=document.getElementById("filterTags");if(t.innerHTML="",s.innerHTML="",r.style.display="block",mobileInput.classList.remove("invalid"),!/^\d{10}$/.test(e))return r.style.display="none",t.innerHTML='<p class="error"><i class="fa-solid fa-heart-crack"></i> Please enter a valid 10-digit mobile number.</p>',void mobileInput.classList.add("invalid");localStorage.setItem("savedMobile",e);try{const n=await fetch(`https://script.google.com/macros/s/AKfycbx3duJLyCpMpvdOrEk4_ixxb4ooXM9rB8rPmP-Uk8hqvx00XAfjL135J8mZZWIy2jz5/exec?mobile=${e}`),a=await n.json();if(console.log("Response data:",JSON.stringify(a,null,2)),r.style.display="none",a.success&&Array.isArray(a.orders)&&a.orders.length>0){const e={};a.orders.forEach((t=>{const r=t.Orders?t.Orders.toLowerCase().replace(/\s+/g,"-"):"opened";e[r]=(e[r]||0)+1}));let r='<span class="tag" data-status="all">All ('+a.orders.length+")</span>";for(const t in e){const s="opened"===t?"Opened":t.replace(/-/g," ").replace(/\b\w/g,(e=>e.toUpperCase()));r+=`<span class="tag" data-status="${t}">${s} (${e[t]})</span>`}s.innerHTML=r;const n=s.getElementsByClassName("tag");let o="all";for(const e of n)e.addEventListener("click",(function(){for(const e of n)e.classList.remove("active");this.classList.add("active"),o=this.getAttribute("data-status");let e="";a.orders.forEach(((t,r)=>{if("all"!==o&&(t.Orders?t.Orders.toLowerCase().replace(/\s+/g,"-"):"opened")!==o)return;const s=t.Brand||"N/A",n=t["Weight per Bag"]||"N/A",a=t.Bags||"N/A",l=t["Total Price"]||"N/A",i=t.Orders||"Opened",c=t.Orders?"status-"+t.Orders.toLowerCase().replace(/\s+/g,"-"):"status-opened",d=formatDate(t.timestamp)||"N/A",p=t.Name||"N/A",g=t.Address||"N/A",u=t["GPS Location"]||"N/A";let f="";[s,n,a,l,i,d,p,g,u].every((e=>"N/A"===e))&&(f=`\n                    <p><strong>Raw Order Data (for debugging):</strong></p>\n                    <pre class="raw-data">${JSON.stringify(t,null,2)}</pre>\n                  `),e+=`\n                  <div class="order">\n                    <h3>Order ${r+1}</h3>\n                    <p><strong>Ordered On:</strong> ${d}</p>\n                    <p><strong>Name:</strong> ${p}</p>\n                    <p><strong>Rice Brand:</strong> ${s}</p>\n                    <p><strong>Weight Per Bag:</strong> ${n}</p>\n                    <p><strong>Total Bags:</strong> ${a}</p>\n                    <p><strong>Total Price:</strong> ${l}</p>\n                    <p class="address-none"><strong>Address:</strong> ${g}</p>\n                    <p class="${c}"><strong>Status:</strong> ${i}</p>\n                    <p><strong>GPS Location:</strong> <a href="${u}" target="_blank" rel="noopener noreferrer">View Location</a></p>\n                    ${f}\n                  </div>\n                `})),t.innerHTML=e||'<p class="error"><i class="fa-solid fa-face-frown"></i> No orders found for this status.</p>'}));n[0].classList.add("active"),n[0].click()}else t.innerHTML='<p class="error"><i class="fa-solid fa-face-frown"></i> '+(a.message||"No orders found.")+"</p>"}catch(e){console.error("Error fetching order details:",e),r.style.display="none",t.innerHTML='<p class="error"><i class="fa-solid fa-face-frown"></i> Error fetching order details. Please try again later.</p>'}}mobileInput.addEventListener("input",(function(e){this.value=this.value.replace(/[^0-9]/g,""),clearIcon.style.display=this.value.length>0?"block":"none"})),clearIcon.addEventListener("click",(function(){mobileInput.value="",localStorage.removeItem("savedMobile"),clearIcon.style.display="none",document.getElementById("result").innerHTML="",document.getElementById("filterTags").innerHTML=""})),window.addEventListener("load",(function(){const e=localStorage.getItem("savedMobile");e&&(mobileInput.value=e,clearIcon.style.display=e.length>0?"block":"none",searchOrder())}));